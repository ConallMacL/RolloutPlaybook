<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Digital Rollout Playbook</title>
<style>
  :root{
    --navy:#0e223f; --teal:#00ffbb; --coral:#ff6b6b;
    --ink:#101828; --muted:#667085;
    --bg:#f5f7fb; --card:#ffffff; --line:#e5e7eb; --chip:#eef2ff;
    --info-bg:#f8fbff; --info-border:#cfe3ff; --info-ring:#eff6ff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial}

  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:10}
  .wrap{max-width:1200px;margin:0 auto;padding:16px 20px}
  h1{font-size:1.25rem;margin:0 0 4px;color:var(--navy)}
  .sub{color:var(--muted);font-size:.92rem}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{background:var(--navy);color:#fff;border:0;border-radius:10px;padding:8px 12px;cursor:pointer}
  button.secondary{background:#fff;color:var(--navy);border:1px solid var(--navy)}
  button:focus{outline:2px solid var(--coral); outline-offset:2px}

  /* Dashboard */
  #dashboard{margin-top:10px;display:grid;gap:10px}
  .dash-row{display:grid;gap:10px;grid-template-columns:1fr}
  .role-grid{display:grid;gap:10px;grid-template-columns:repeat(4,1fr)}
  @media (max-width:900px){.role-grid{grid-template-columns:1fr 1fr}}
  .stat{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
  .stat .label{font-size:.82rem;color:#334155;margin-bottom:6px;display:flex;justify-content:space-between}
  .meter{height:10px;background:#f1f5f9;border-radius:999px;position:relative;overflow:hidden}
  .meter > span{display:block;height:100%;background:linear-gradient(90deg,var(--navy),#1f4b99);width:0}
  .pct{font-variant-numeric:tabular-nums}

  main{padding:16px 20px}
  .grid{max-width:1200px;margin:0 auto;display:grid;gap:16px;grid-template-columns:repeat(4,1fr)}
  @media (max-width:1100px){.grid{grid-template-columns:1fr}}
  .col{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
  .kicker{font-size:.72rem;letter-spacing:.06em;color:#334155;text-transform:uppercase}
  .col h2{margin:2px 0 4px;font-size:1.05rem}
  .progress{font-size:.82rem;color:var(--muted);margin:4px 0 6px;font-weight:600}

  /* header meters inside columns */
  .col-meter{height:8px;background:#f1f5f9;border-radius:999px;overflow:hidden;margin:-2px 0 8px}
  .col-meter > span{display:block;height:100%;background:linear-gradient(90deg,var(--teal),#18d4a4);width:0}

  .card{border:1px solid var(--line);border-radius:12px;padding:12px;margin:10px 0}
  .task-title{display:flex;align-items:center;gap:8px;font-weight:600;margin:0 0 6px}
  .task-title input[type="checkbox"]{width:18px;height:18px;cursor:pointer}
  .notes{color:#475569;margin:6px 0}
  .meta{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0}
  input[type="date"]{border:1px solid var(--line);border-radius:8px;padding:6px 8px}
  .date-label{font-size:.72rem;background:var(--chip);padding:.15rem .5rem;border-radius:999px;color:#374151}
  ul{margin:8px 0 0 18px}

  /* completion visuals */
  .done .task-title,.done .notes,.done li{opacity:.6;text-decoration:line-through}
  .bucket-done .kicker, .bucket-done h2{ text-decoration:line-through; opacity:.6 }
  li.part-done{ text-decoration:line-through; opacity:.6 }
  .check{ width:16px; height:16px; vertical-align:-2px; margin-right:6px; cursor:pointer }

  /* Roles/FYI column visuals */
  .col.info{ background:var(--info-bg); border-color:var(--info-border) }
  .card.info{ background:#fff; border-color:#dbeafe; box-shadow: inset 0 0 0 2px var(--info-ring) }
  .info-note{ color:#475569; font-size:.9rem; margin:6px 0 0 }

  /* Role pills */
  .tag{
    display:inline-block; font-size:.72rem; padding:.15rem .5rem;
    border-radius:999px; margin-left:6px; border:1px solid transparent;
  }
  .tag.slt, .tag[data-role-key="slt"]{ background:#e0f2fe; color:#075985; border-color:#7dd3fc; }
  .tag.dla, .tag[data-role-key="dla"]{ background:#fef9c3; color:#713f12; border-color:#fde047; }
  .tag.it,  .tag[data-role-key="it"]  { background:#dcfce7; color:#166534; border-color:#86efac; }
  .tag.digital-lead, .tag[data-role-key="digital-lead"]{ background:#fce7f3; color:#831843; border-color:#f9a8d4; }

  /* Mobile niceties */
  @media (max-width:600px){
    .wrap{padding:12px 14px}
    .card{padding:10px}
    .meta{gap:6px}
    .date-label{display:none}
  }

  /* Print polish */
  @media print{
    header,.legend,footer{display:none}
    main{padding:0}
    .grid{grid-template-columns:1fr 1fr 1fr}
    .col{page-break-inside:avoid}
    .card.done{ background:#f3f4f6 }
  }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Digital Rollout Playbook</h1>
    <div class="sub">Before → During → After • Set school-specific dates • Mark tasks done • Export CSV • Print</div>
    <div class="controls">
      <button aria-label="Export dates and status as CSV" onclick="exportCSV()">Export dates & status (CSV)</button>
      <button class="secondary" aria-label="Print this playbook" onclick="window.print()">Print</button>
      <button class="secondary" aria-label="Copy share link with current plan parameter" onclick="copyLink()">Copy share link</button>
    </div>
  </div>
</header>

<div id="dashboard" class="wrap"></div>

<main>
  <section id="board" class="grid"></section>
  <div class="legend wrap" style="margin-top:12px;background:#fff;border:1px dashed var(--line);border-radius:12px;padding:12px">
    <strong>Roles</strong> — <em>SLT</em> (Sponsors/Owners), <em>Digital Lead</em> (Anchor/Innovator),
    <em>IT</em> (Enablers/Sustainers), <em>DLA</em> (Guide/Critical Friend).
  </div>
</main>

<footer class="wrap" style="color:var(--muted);font-size:.85rem;margin:6px auto 20px">
  © Cognita Digital Learning • Tip: append <code>?plan=arp.json</code> to preload dates for a school (optional).
</footer>

<script>
/* ===== MASTER TASK DATA ===== */
const MASTER = {"generated_from":"Rollout Playbook (1).xlsx","tasks":[
{"id":"1vhy_lhX6EyJS1UjZLY0OpYACA9d","title":"Technical - IT","bucket":"Roles ","label":null,"notes":"","checklist":[],"due":"2026-02-22","start":null},
{"id":"2j-j36sTh02tVJ3GreVJ35YAOaA1","title":"Identify goals and objectives","bucket":"Prepping for Rollout","label":"Digital Lead","notes":"","checklist":["Review CPD content — confident staff will know what to do on Day 1.","Share pupil induction lessons (iPad care, agreements).", "All required apps are on App Catalogue and shared with IT in timely fashion.", "Staff understand process/system around breakages.","Promote Apple Teacher programme to staff.","Adapt Comms for your school to parents"],"due":null,"start":null},
{"id":"8mlMW5no8kqwdD4fU8bE1JYABG50","title":"SLT","bucket":"Rollout","label":"SLT","notes":"","checklist":["Student agreements signed and logged.","Senior SLT link identified to support and guide the Digital Lead.","All SLT onboard with Narrative (read/adapt cheat sheet!)","Lead visible messaging: “This is about teaching and learning, not tech."],"due":null,"start":null},
{"id":"D-AqqtD09U2I7G1xbrmEfJYAKwWx","title":"Strategic - Cross-School/Outside Liaison*- DLA","bucket":"Roles ","label":null,"notes":"Also available to support Digital Learning Lead upon request.","checklist":[],"due":null,"start":null},
{"id":"Ew1S2s5k1kyxXy3cptZD9ZYAPFsj","title":"Ownership/Vision/Operational Oversight - SLT","bucket":"Roles ","label":null,"notes":"","checklist":[],"due":null,"start":null},
{"id":"GAh6fcINTE2xu88ypBAUwJYADL3E","title":"IT","bucket":"Rollout","label":"IT","notes":"","checklist":["First Weeks - on hand to support troubleshooting. Share solutions to common problems.","Regularly review (with SLT + DL) to resolve issues quickly.","Confirm apps are deployed and accessible. Devices are working as expected in the classroom."],"due":null,"start":null},
{"id":"KaBwb0El5k62tR-tsVs015YAMFix","title":"Digital Lead","bucket":"Rollout","label":"Digital Lead","notes":"","checklist":["First point of contact for staff queries around Pedagogy.","Lead day-to-day CPD sessions in school (short inputs, Apple Teacher nudges).","Gauge staff digital maturity in an ongoing manner"],"due":null,"start":null},
{"id":"LOiolTKpcEOQSQy9fW0SNJYAOuLs","title":"Digital Lead","bucket":"After Rollout","label":"Digital Lead","notes":"","checklist":["Onboard and mentor Digital Champions and Ambassadors.","Ensure digital practice is becoming embedded across year groups and departments.","Identify Best Practice."],"due":null,"start":null},
{"id":"Qw-LE4-ddEWoo_bXKUptT5YAMU7Y","title":"SLT","bucket":"After Rollout","label":"SLT","notes":"","checklist":["Check in with stakeholders to direct future of digital learning.","Review digital learning impact as part of routine leadership review.","Continue proactive comms with parents and governors to show progress and value.","Embed digital into the School Development/Improvement Plan"],"due":null,"start":null},
{"id":"aTHwxoCfLUO_2V-uGHmZMZYACUQ3","title":"DLA","bucket":"Rollout","label":"DLA","notes":"","checklist":["Check-ins with Digital Leads - 'How can I help?'","Troubleshoot barriers with DL/SLT/IT - add to existing resources to improve rollout system.","Co-deliver CPD sessions: frame pedagogy (MECC/PICRAT) and model Apple workflows."],"due":null,"start":null},
{"id":"hWXZpBzPD0SWD2QFqJIPRpYAK1vF","title":"School Leadership","bucket":"Prepping for Rollout","label":"SLT","notes":"These are the whats, always think, 'who needs to know?'","checklist":["Who leads on these key strands: arranging CPD, pupil induction, parent comms, apps.","Parents have received clear comms (expectations, support, 5Ws).","Parents are clearly informed of the procedure around breakages (repairs, costs, replacement timeline","Training dates are scheduled and communicated to staff."],"due":null,"start":null},
{"id":"oGVukcdBEUKKDMGCeSvQCpYAKwe1","title":"DLA","bucket":"After Rollout","label":"DLA","notes":"","checklist":["DMS - Digital Lead and relevant SLT informed","Arrange/Plan sessions for Digital Lead and Champions","Support Innovation projects.","Identify & Promote best practice - case study"],"due":null,"start":null},
{"id":"sGuhNgGNXkaJcjY12fDr05YAMElz","title":"DLA","bucket":"Prepping for Rollout","label":"DLA","notes":"","checklist":["Check expectations and clarify support with SLT.","Provide Rollout Resource Pack"],"due":null,"start":null},
{"id":"v5u087LLQ0OK6iIMp80pxpYAF7VI","title":"Operational and in-school - Digital Learning Lead","bucket":"Roles ","label":null,"notes":"","checklist":[],"due":"2025-11-22","start":null},
{"id":"wC-KABIUakeZnOCx1HcyPZYABOti","title":"IT","bucket":"After Rollout","label":"IT","notes":"","checklist":["Maintenance: Updates, Safeguarding, Security.","Termly check ins to ensure alignment.","Support expansion and streamlining of core apps in line with curriculum needs.","Reflect on this year's rollout to inform best practice next AY."],"due":null,"start":null},
{"id":"y4tR6fEZQE2SRFzZFXfxI5YAGd0B","title":"IT","bucket":"Prepping for Rollout","label":"IT","notes":"","checklist":["Devices built/configured and core apps pushed to self-service.","CPD date confirmed so IT can provide support.","Any risks/setbacks in device readiness communicated to SLT.","School are aware of policies on breakages.","Are AppleTVs installed and staff able to Airplay."],"due":null,"start":null}
]};

/* ===== helpers/state ===== */
const BUCKET_ORDER = ["Prepping for Rollout","Rollout","After Rollout","Roles "];
const INFO_BUCKET = "Roles ";
const PLAN_KEY = new URLSearchParams(location.search).get('plan') || 'default';
const STORAGE_KEY = `playbook_${PLAN_KEY}`;

async function loadPlanByUrl(url){
  try{
    const res = await fetch(url,{cache:'no-store'});
    if(!res.ok) return;
    const loaded = await res.json();
    const map = Object.fromEntries((loaded.tasks||[]).map(t=>[String(t.id),t]));
    MASTER.tasks.forEach(t=>{
      const m = map[t.id]; if(!m) return;
      if(m.start) t.start = m.start;
      if(m.due)   t.due   = m.due;
    });
  }catch(_){}
}

function loadLocalState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const s = JSON.parse(raw);
    const map = s.byId || {};
    MASTER.tasks.forEach(t=>{
      const v = map[t.id]; if(!v) return;
      t.start = v.start ?? t.start ?? null;
      t.due   = v.due   ?? t.due   ?? null;
      t.done  = !!v.done;
      if(Array.isArray(v.parts)){
        t.parts = v.parts.slice(0,(t.checklist||[]).length).map(Boolean);
      }
    });
  }catch(_){}
}
function saveLocalState(){
  const byId = {};
  MASTER.tasks.forEach(t=>{
    byId[t.id] = {start:t.start||null, due:t.due||null, done:!!t.done, parts:(t.parts||[]).map(Boolean)};
  });
  localStorage.setItem(STORAGE_KEY, JSON.stringify({byId}));
}

/* logic */
function isTaskDone(t){
  const hasParts = Array.isArray(t.checklist) && t.checklist.length>0;
  const partsAll = hasParts ? (Array.isArray(t.parts) && t.parts.length===t.checklist.length && t.parts.every(Boolean)) : false;
  return !!(t.done || partsAll);
}
function byBucket(tasks){
  const m=new Map(); BUCKET_ORDER.forEach(b=>m.set(b,[]));
  tasks.forEach(t=>m.set(t.bucket,(m.get(t.bucket)||[]).concat(t)));
  return m;
}

/* compute dashboard numbers */
function computeProgress(){
  const roles = ["SLT","Digital Lead","IT","DLA"];
  const roleTotals = Object.fromEntries(roles.map(r=>[r,{done:0,total:0}]));
  const phaseTotals = {"Prepping for Rollout":{done:0,total:0},"Rollout":{done:0,total:0},"After Rollout":{done:0,total:0}};
  let overall = {done:0,total:0};

  MASTER.tasks.forEach(t=>{
    if(t.bucket===INFO_BUCKET) return; // ignore FYI column for progress
    const done = isTaskDone(t);
    phaseTotals[t.bucket].total++; if(done) phaseTotals[t.bucket].done++;
    overall.total++; if(done) overall.done++;
    if(t.label && roleTotals[t.label]){
      roleTotals[t.label].total++; if(done) roleTotals[t.label].done++;
    }
  });
  return {overall, roleTotals, phaseTotals};
}

/* small helper for meters */
function pct(done,total){ return total ? Math.round((done/total)*100) : 0; }
function meterHTML(done,total,accent=''){
  const p = pct(done,total);
  const style = accent ? `style="background:${accent}"` : '';
  return `<div class="meter"><span ${style} style="width:${p}%"></span></div>
          <div class="label" style="margin-top:6px;justify-content:flex-end"><span class="pct">${p}%</span>&nbsp;(${done}/${total})</div>`;
}

/* render dashboard */
function renderDashboard(){
  const d = computeProgress();
  const dash = document.getElementById('dashboard');
  dash.innerHTML = `
    <div class="dash-row">
      <div class="stat">
        <div class="label"><strong>Overall progress</strong><span class="pct">${pct(d.overall.done,d.overall.total)}%</span></div>
        <div class="meter"><span style="width:${pct(d.overall.done,d.overall.total)}%"></span></div>
      </div>
    </div>
    <div class="role-grid">
      ${Object.entries(d.roleTotals).map(([role,vals])=>`
        <div class="stat">
          <div class="label"><span>${role}</span><span class="pct">${pct(vals.done,vals.total)}%</span></div>
          <div class="meter"><span style="width:${pct(vals.done,vals.total)}%"></span></div>
        </div>
      `).join('')}
    </div>
  `;
}

/* render board */
function render(){
  renderDashboard();

  const board=document.getElementById('board');
  board.innerHTML='';
  const grouped=byBucket(MASTER.tasks);

  BUCKET_ORDER.forEach(bucket=>{
    const tasks = grouped.get(bucket)||[];
    const isInfo = bucket===INFO_BUCKET;
    const doneCount = isInfo ? 0 : tasks.filter(isTaskDone).length;
    const allDone = !isInfo && tasks.length>0 && doneCount===tasks.length;

    const col=document.createElement('div');
    col.className='col'+(allDone?' bucket-done':'')+(isInfo?' info':'');
    const title = bucket.trim()==="Prepping for Rollout" ? "Preparation & Alignment"
               : bucket.trim()==="Rollout" ? "Stabilisation & Embedding"
               : bucket.trim()==="After Rollout" ? "Sustainability & Growth"
               : "Roles";

    // per-section meter
    const sectionPct = isInfo ? 0 : Math.round((doneCount/(tasks.length||1))*100);

    col.innerHTML=`<div class="kicker">${bucket.trim()}</div>
                   <h2>${title}</h2>
                   ${isInfo?'':`<div class="progress">${doneCount}/${tasks.length} done</div>
                   <div class="col-meter"><span style="width:${sectionPct}%"></span></div>`}`;

    tasks.forEach(t=>{
      // align parts
      if(Array.isArray(t.checklist) && t.checklist.length){
        if(!Array.isArray(t.parts)) t.parts=Array(t.checklist.length).fill(false);
        if(t.parts.length!==t.checklist.length){
          const p=Array(t.checklist.length).fill(false);
          for(let i=0;i<Math.min(p.length,t.parts.length);i++) p[i]=!!t.parts[i];
          t.parts=p;
        }
      }else{ t.parts=[]; }

      // safe role pill
      const roleRaw = (t.label ?? '').toString().trim();
      const roleKey = roleRaw.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
      const roleTag = roleRaw ? ` <span class="tag ${roleKey}" data-role="${roleRaw}" data-role-key="${roleKey}">${roleRaw}</span>` : '';

      const card=document.createElement('div');
      card.className='card'+(isInfo?' info':(isTaskDone(t)?' done':''));

      if(isInfo){
        card.innerHTML = `
          <div class="task-title"><span>${t.title}${roleTag}</span></div>
          ${t.notes?`<div class="info-note">${t.notes}</div>`:''}
          ${t.checklist && t.checklist.length ? `<ul>${t.checklist.map(x=>`<li>${x}</li>`).join('')}</ul>`:''}
        `;
      }else{
        card.innerHTML = `
          <div class="task-title">
            <input type="checkbox" class="donebox" data-id="${t.id}" ${t.done?'checked':''}/>
            <span>${t.title}${roleTag}</span>
          </div>
          ${t.notes?`<div class="notes">${t.notes}</div>`:''}
          <div class="meta">
            <span class="date-label">Start</span>
            <input title="Changes save automatically" type="date" class="date" data-id="${t.id}" data-type="start" value="${t.start||''}">
            <span class="date-label">Due</span>
            <input title="Changes save automatically" type="date" class="date" data-id="${t.id}" data-type="due" value="${t.due||''}">
          </div>
          ${
            t.checklist && t.checklist.length
            ? `<ul>` + t.checklist.map((txt,idx)=>`
                <li class="${t.parts[idx]?'part-done':''}">
                  <input class="check partbox" type="checkbox" data-id="${t.id}" data-idx="${idx}" ${t.parts[idx]?'checked':''}/>
                  ${txt}
                </li>`).join('') + `</ul>`
            : ''
          }
        `;
      }
      col.appendChild(card);
    });

    board.appendChild(col);
  });

  // wire inputs for non-info cards
  document.querySelectorAll('input.date').forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const t=MASTER.tasks.find(x=>x.id===inp.dataset.id);
      t[inp.dataset.type]=inp.value||null;
      saveLocalState(); renderDashboard(); // update dash if dates imply completion later
    });
  });
  document.querySelectorAll('input.donebox').forEach(box=>{
    box.addEventListener('change', ()=>{
      const t=MASTER.tasks.find(x=>x.id===box.dataset.id);
      t.done=box.checked; saveLocalState(); render(); // re-render to refresh meters
    });
  });
  document.querySelectorAll('input.partbox').forEach(pb=>{
    pb.addEventListener('change', ()=>{
      const t=MASTER.tasks.find(x=>x.id===pb.dataset.id);
      const i=Number(pb.dataset.idx);
      if(!Array.isArray(t.parts)) t.parts=[];
      t.parts[i]=pb.checked; saveLocalState(); render();
    });
  });
}

/* export */
function exportCSV(){
  const rows=[["Task ID","Title","Bucket","Label","Start","Due","Done"]];
  MASTER.tasks.forEach(t=>{
    rows.push([t.id,t.title,t.bucket.trim(),t.label||"",t.start||"",t.due||"",isTaskDone(t)?"Yes":"No"]);
  });
  const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='rollout-dates-status.csv'; a.click();
}

/* copy share link */
function copyLink(){
  const plan = new URLSearchParams(location.search).get('plan') || '';
  if(!plan){ alert('Tip: add ?plan=<school>.json to the URL to share a preloaded plan.'); return; }
  navigator.clipboard.writeText(location.href).then(()=>alert('Link copied!'));
}

/* boot */
(async function init(){
  const plan=new URLSearchParams(location.search).get('plan');
  if(plan) await loadPlanByUrl('./plans/'+plan);
  loadLocalState();
  render();
})();
</script>
</body>
</html>
